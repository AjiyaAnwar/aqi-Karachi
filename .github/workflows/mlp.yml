name: AQI Karachi ML Pipeline - PRODUCTION

on:
  # ========== SCHEDULED RUNS ==========
  schedule:
    # Data collection every 3 hours
    - cron: '0 */3 * * *'
    
    # Feature engineering daily at 1 AM UTC
    - cron: '0 1 * * *'
    
    # Training twice daily (4 AM & 4 PM UTC)
    - cron: '0 4 * * *'
    - cron: '0 16 * * *'
    
    # Full pipeline every Sunday at 5 AM UTC
    - cron: '0 5 * * 0'
  
  # ========== MANUAL TRIGGER ==========
  workflow_dispatch:
    inputs:
      pipeline_step:
        description: 'Select pipeline step to run'
        required: false
        default: 'full'
        type: choice
        options:
          - data_incremental
          - data_full
          - features
          - train_combined
          - predictions
          - full
  
  # ========== CODE PUSH TRIGGER ==========
  push:
    branches: [main]
    paths:
      - 'aqi-karachi/**'
      - '.github/workflows/**'

jobs:
  execute-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      CITY_NAME: Karachi
      CITY_LAT: 24.8607
      CITY_LON: 67.0011
      TIMEZONE: Asia/Karachi
      GITHUB_ACTIONS: true
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pymongo python-dotenv pandas numpy scikit-learn joblib
        pip install streamlit plotly
        pip install xgboost
        pip install pystan~=2.14
        pip install prophet
        pip install requests
        pip install scipy
    
    - name: Determine pipeline step
      id: determine_step
      run: |
        echo "ðŸ” Determining pipeline step..."
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          STEP="${{ github.event.inputs.pipeline_step }}"
          echo "Manual trigger, step: $STEP"
          echo "step=$STEP" >> $GITHUB_OUTPUT
          
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          
          echo "Scheduled trigger, UTC Hour: $HOUR, Day: $DAY"
          
          case $HOUR in
            "00"|"03"|"06"|"09"|"12"|"15"|"18"|"21")
              echo "Running incremental data collection"
              echo "step=data_incremental" >> $GITHUB_OUTPUT
              ;;
            "01")
              echo "Running feature engineering"
              echo "step=features" >> $GITHUB_OUTPUT
              ;;
            "04"|"16")
              echo "Running combined training"
              echo "step=train_combined" >> $GITHUB_OUTPUT
              ;;
            "05")
              if [[ $DAY -eq 7 ]]; then
                echo "Running full pipeline (Sunday)"
                echo "step=full" >> $GITHUB_OUTPUT
              else
                echo "Skipping (not Sunday)"
                echo "step=skip" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "No scheduled task"
              echo "step=skip" >> $GITHUB_OUTPUT
              ;;
          esac
          
        else
          echo "Push event, running full pipeline"
          echo "step=full" >> $GITHUB_OUTPUT
        fi
    
    - name: Execute Data Collection (Incremental)
      if: steps.determine_step.outputs.step == 'data_incremental'
      run: |
        echo "ðŸš€ Running incremental data collection..."
        cd aqi-karachi
        python data_pipeline/fetch_incremental.py
    
    - name: Execute Data Collection (Full)
      if: steps.determine_step.outputs.step == 'data_full'
      run: |
        echo "ðŸš€ Running full data collection..."
        cd aqi-karachi
        python data_pipeline/collect_historical.py
    
    - name: Execute Feature Engineering
      if: steps.determine_step.outputs.step == 'features'
      run: |
        echo "ðŸš€ Running feature engineering..."
        cd aqi-karachi
        python data_pipeline/features.py
    
    - name: Execute Model Training
      if: steps.determine_step.outputs.step == 'train_combined'
      run: |
        echo "ðŸš€ Running model training and predictions..."
        cd aqi-karachi
        python model_training/runallmodels.py
    
    - name: Execute Predictions Only
      if: steps.determine_step.outputs.step == 'predictions'
      run: |
        echo "ðŸš€ Running predictions..."
        cd aqi-karachi
        python cicd/scripts/run_predictions.py
    
    - name: Execute Full Pipeline
      if: steps.determine_step.outputs.step == 'full'
      run: |
        echo "ðŸš€ Running FULL pipeline..."
        cd aqi-karachi
        echo "Step 1: Data Collection..."
        python data_pipeline/collect_historical.py
        echo "Step 2: Feature Engineering..."
        python data_pipeline/features.py
        echo "Step 3: Model Training & Predictions..."
        python model_training/runallmodels.py
    
    - name: Summary
      run: |
        echo "ðŸ“Š PIPELINE SUMMARY"
        echo "Step executed: ${{ steps.determine_step.outputs.step }}"
        echo "Status: ${{ job.status }}"
        echo "Time Karachi: $(TZ='Asia/Karachi' date '+%Y-%m-%d %H:%M:%S %Z')"
