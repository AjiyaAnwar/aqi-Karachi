name: AQI Karachi ML Pipeline - PRODUCTION

on:
  schedule:
    # Hourly feature updates (as required)
    - cron: '0 */1 * * *'
    
    # 3-hourly data collection
    - cron: '0 */3 * * *'
    
    # Daily training
    - cron: '0 2 * * *'    # Daily at 2 AM UTC
    
    # Weekly full pipeline
    - cron: '0 5 * * 0'    # Sunday at 5 AM UTC
  
  workflow_dispatch:
    inputs:
      pipeline_step:
        description: 'Select pipeline step to run'
        required: false
        default: 'full'
        type: choice
        options:
          - data_incremental
          - data_full
          - features
          - train_combined
          - predictions
          - alerts_check
          - full
  
  push:
    branches: [main]
    paths:
      - 'aqi-karachi/**'
      - '.github/workflows/**'

jobs:
  execute-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      MONGODB_DATABASE: aqi_predictor
      FEATURE_STORE_DB: aqi_feature_store
      MODEL_REGISTRY_DB: aqi_model_registry
      LOGS_DB: aqi_pipeline_logs
      
      CITY_NAME: Karachi
      CITY_LAT: 24.8607
      CITY_LON: 67.0011
      TIMEZONE: Asia/Karachi
      
      GITHUB_ACTIONS: true
      PYTHONPATH: ${{ github.workspace }}/aqi-karachi:${{ github.workspace }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pymongo python-dotenv pandas scikit-learn joblib
        pip install streamlit plotly
        pip install xgboost
        pip install prophet
        pip install requests
        pip install scipy
        echo "‚úÖ Dependencies installed"
    
    - name: Determine pipeline step
      id: determine_step
      run: |
        echo "üîç Determining pipeline step..."
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          STEP="${{ github.event.inputs.pipeline_step }}"
          echo "Manual trigger, step: $STEP"
          echo "step=$STEP" >> $GITHUB_OUTPUT
          
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          
          case $HOUR in
            "00"|"01"|"02"|"03"|"04"|"05"|"06"|"07"|"08"|"09"|"10"|"11"|"12"|"13"|"14"|"15"|"16"|"17"|"18"|"19"|"20"|"21"|"22"|"23")
              echo "Running hourly feature engineering"
              echo "step=features" >> $GITHUB_OUTPUT
              ;;
            "02")
              echo "Running daily training"
              echo "step=train_combined" >> $GITHUB_OUTPUT
              ;;
            "03"|"06"|"09"|"12"|"15"|"18"|"21")
              echo "Running incremental data collection"
              echo "step=data_incremental" >> $GITHUB_OUTPUT
              ;;
            "05")
              if [[ $DAY -eq 7 ]]; then
                echo "Running full pipeline (Sunday)"
                echo "step=full" >> $GITHUB_OUTPUT
              else
                echo "step=skip" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "step=skip" >> $GITHUB_OUTPUT
              ;;
          esac
          
        else
          echo "Push event, running full pipeline"
          echo "step=full" >> $GITHUB_OUTPUT
        fi
    
    - name: Execute Data Collection (Incremental)
      if: steps.determine_step.outputs.step == 'data_incremental'
      run: |
        echo "üöÄ Running incremental data collection..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python data_pipeline/fetch_incremental.py
    
    - name: Execute Data Collection (Full)
      if: steps.determine_step.outputs.step == 'data_full'
      run: |
        echo "üöÄ Running full data collection..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python data_pipeline/collect_historical.py
    
    - name: Execute Feature Engineering (Hourly)
      if: steps.determine_step.outputs.step == 'features'
      run: |
        echo "üöÄ Running hourly feature engineering..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python data_pipeline/features.py
    
    - name: Execute Model Training
      if: steps.determine_step.outputs.step == 'train_combined'
      run: |
        echo "üöÄ Running model training and predictions..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python model_training/runallmodels.py
    
    - name: Execute Full Pipeline
      if: steps.determine_step.outputs.step == 'full'
      run: |
        echo "üöÄ Running FULL pipeline..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python data_pipeline/collect_historical.py
        python data_pipeline/features.py
        python model_training/runallmodels.py
    
    - name: Check AQI Alerts
      if: steps.determine_step.outputs.step == 'alerts_check' || steps.determine_step.outputs.step == 'full'
      run: |
        echo "üö® Checking for hazardous AQI levels..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python -c "
        from pymongo import MongoClient
        import os
        from dotenv import load_dotenv
        load_dotenv()
        
        client = MongoClient(os.getenv('MONGODB_URI'))
        db = client[os.getenv('MONGODB_DATABASE', 'aqi_predictor')]
        
        latest_aqi = db.aqi_measurements.find_one(sort=[('timestamp', -1)])
        if latest_aqi:
            current_aqi = latest_aqi.get('aqi', 0)
            if current_aqi > 300:
                print('üö®üö®üö® HAZARDOUS AQI LEVEL! Immediate action required!')
            elif current_aqi > 200:
                print('‚ö†Ô∏è‚ö†Ô∏è VERY UNHEALTHY AQI! Sensitive groups avoid outdoors.')
        "
    
    - name: Auto-generate forecasts if missing
      if: steps.determine_step.outputs.step != 'skip'
      run: |
        echo "üîç Checking if forecasts exist..."
        cd aqi-karachi
        export PYTHONPATH="$PYTHONPATH:$(pwd)"
        python -c "
        from pymongo import MongoClient
        import os
        load_dotenv()
        
        client = MongoClient(os.getenv('MONGODB_URI'))
        db = client[os.getenv('MONGODB_DATABASE', 'aqi_predictor')]
        
        forecast_collections = ['ensemble_forecasts_3day', 'ml_recursive_forecasts', 'timeseries_forecasts_3day']
        has_forecasts = any(col in db.list_collection_names() and db[col].count_documents({}) > 0 for col in forecast_collections)
        
        if not has_forecasts:
            print('‚ö†Ô∏è No forecasts found! Running predictions...')
            import subprocess
            try:
                subprocess.run(['python', 'model_training/runallmodels.py'], check=True)
            except:
                print('‚ùå Failed to generate predictions')
        "
    
    - name: Summary
      run: |
        echo "üìä PIPELINE SUMMARY"
        echo "Step executed: ${{ steps.determine_step.outputs.step }}"
        echo "Status: ${{ job.status }}"
        echo "Time Karachi: $(TZ='Asia/Karachi' date '+%Y-%m-%d %H:%M:%S %Z')"
