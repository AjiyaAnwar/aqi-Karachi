name: AQI Karachi ML Pipeline - PRODUCTION FIXED

on:
  schedule:
    - cron: '0 */3 * * *'
    - cron: '0 1 * * *'
    - cron: '0 4 * * *'
    - cron: '0 16 * * *'
    - cron: '0 5 * * 0'
    
  workflow_dispatch:
    inputs:
      pipeline_step:
        description: 'Select pipeline step to run'
        required: false
        default: 'full'
        type: choice
        options:
          - data_incremental
          - data_full
          - features
          - train_combined
          - predictions
          - full
    
  push:
    branches: [main]
    paths:
      - 'aqi-karachi/data_pipeline/**'
      - 'aqi-karachi/model_training/**'
      - '.github/workflows/**'
      - 'aqi-karachi/requirements.txt'

jobs:
  execute-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production
    
    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      MONGODB_DATABASE: aqi_predictor
      FEATURE_STORE_DB: aqi_feature_store
      MODEL_REGISTRY_DB: aqi_model_registry
      LOGS_DB: aqi_pipeline_logs
      CITY_NAME: Karachi
      CITY_LAT: 24.8607
      CITY_LON: 67.0011
      TIMEZONE: Asia/Karachi
      HISTORICAL_DAYS: 45
      COLLECTION_INTERVAL_HOURS: 1
      TRAINING_THRESHOLD: 0.7
      MODEL_PROMOTION_THRESHOLD: 0.75
      GITHUB_ACTIONS: true
      LOG_LEVEL: INFO
      PROJECT_ROOT: aqi-karachi  # NEW: Set project root
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Navigate to project directory
      run: |
        echo "üìÅ Repository structure:"
        ls -la
        echo ""
        echo "üìÇ Checking aqi-karachi directory:"
        if [ -d "aqi-karachi" ]; then
          echo "‚úÖ aqi-karachi directory exists"
          ls -la aqi-karachi/
        else
          echo "‚ùå aqi-karachi directory NOT FOUND"
          echo "Available directories:"
          find . -maxdepth 2 -type d | sort
        fi
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Check if requirements.txt exists in aqi-karachi
        if [ -f "aqi-karachi/requirements.txt" ]; then
          echo "üì¶ Installing from aqi-karachi/requirements.txt"
          pip install -r aqi-karachi/requirements.txt
        else
          echo "üì¶ Installing packages directly"
          pip install pymongo python-dotenv pandas numpy scikit-learn joblib requests plotly
        fi
        
        echo "‚úÖ Installed packages:"
        pip list | grep -E "(pymongo|dotenv|pandas|numpy|scikit|joblib|requests|plotly)"
    
    - name: Create .env file in project directory
      run: |
        echo "Creating .env file in aqi-karachi directory..."
        
        # Create directory if it doesn't exist
        mkdir -p aqi-karachi
        
        cat << EOF > aqi-karachi/.env
        # Auto-generated from GitHub Secrets and workflow env
        MONGODB_URI=${{ secrets.MONGODB_URI }}
        MONGODB_DATABASE=aqi_predictor
        FEATURE_STORE_DB=aqi_feature_store
        MODEL_REGISTRY_DB=aqi_model_registry
        LOGS_DB=aqi_pipeline_logs
        CITY_NAME=Karachi
        CITY_LAT=24.8607
        CITY_LON=67.0011
        TIMEZONE=Asia/Karachi
        HISTORICAL_DAYS=45
        COLLECTION_INTERVAL_HOURS=1
        TRAINING_THRESHOLD=0.7
        MODEL_PROMOTION_THRESHOLD=0.75
        GITHUB_ACTIONS=true
        LOG_LEVEL=INFO
        PROJECT_ROOT=aqi-karachi
        EOF
        
        echo "üîê .env file created at aqi-karachi/.env"
        head -3 aqi-karachi/.env
    
    - name: Test MongoDB connection
      run: |
        echo "üîå Testing MongoDB connection..."
        cd aqi-karachi  # Change to project directory
        python -c "
        import os
        from pymongo import MongoClient
        
        uri = os.getenv('MONGODB_URI')
        print(f'URI present: {'Yes' if uri else 'No'}')
        
        if not uri:
            print('‚ùå MONGODB_URI not found in environment')
            print('Current directory:', os.getcwd())
            print('Files in directory:', os.listdir('.'))
            exit(1)
        
        try:
            client = MongoClient(uri, serverSelectionTimeoutMS=10000)
            client.server_info()
            print('‚úÖ MongoDB connection successful')
            
            dbs = client.list_database_names()
            print(f'üìä Available databases: {len(dbs)}')
            
            target_db = 'aqi_predictor'
            if target_db in dbs:
                print(f'‚úÖ Target database ({target_db}) exists')
                collections = client[target_db].list_collection_names()
                print(f'   Collections found: {len(collections)}')
                if collections:
                    print(f'   First 5: {collections[:5]}')
            else:
                print(f'‚ö†Ô∏è  Target database ({target_db}) not found')
                
        except Exception as e:
            print(f'‚ùå MongoDB connection failed: {e}')
            exit(1)
        "
    
    - name: Determine pipeline step
      id: determine_step
      run: |
        echo "üîç Determining pipeline step..."
        
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          STEP="${{ github.event.inputs.pipeline_step }}"
          echo "Manual trigger, step: $STEP"
          echo "step=$STEP" >> $GITHUB_OUTPUT
          
        elif [[ "${{ github.event_name }}" == "schedule" ]]; then
          HOUR=$(date -u +%H)
          DAY=$(date -u +%u)
          
          echo "Scheduled trigger, UTC Hour: $HOUR, Day: $DAY"
          
          case $HOUR in
            "00"|"03"|"06"|"09"|"12"|"15"|"18"|"21")
              echo "Running incremental data collection"
              echo "step=data_incremental" >> $GITHUB_OUTPUT
              ;;
            "01")
              echo "Running feature engineering"
              echo "step=features" >> $GITHUB_OUTPUT
              ;;
            "04"|"16")
              echo "Running combined training (YOUR SCRIPT)"
              echo "step=train_combined" >> $GITHUB_OUTPUT
              ;;
            "05")
              if [[ $DAY -eq 7 ]]; then
                echo "Running full pipeline (Sunday)"
                echo "step=full" >> $GITHUB_OUTPUT
              else
                echo "Skipping (not Sunday)"
                echo "step=skip" >> $GITHUB_OUTPUT
              fi
              ;;
            *)
              echo "No scheduled task"
              echo "step=skip" >> $GITHUB_OUTPUT
              ;;
          esac
          
        else
          echo "Push event, running full pipeline"
          echo "step=full" >> $GITHUB_OUTPUT
        fi
    
    - name: Execute pipeline step
      id: execute_pipeline
      if: steps.determine_step.outputs.step != 'skip'
      run: |
        STEP="${{ steps.determine_step.outputs.step }}"
        
        echo "üöÄ Executing: $STEP"
        echo "üïí UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
        echo "üïê Karachi: $(TZ='Asia/Karachi' date '+%Y-%m-%d %H:%M:%S')"
        
        # Change to project directory
        cd aqi-karachi
        echo "üìÅ Working in: $(pwd)"
        
        case $STEP in
          "data_incremental")
            echo "üì• Running incremental data collection..."
            if [ -f "data_pipeline/collect_historical.py" ]; then
              python data_pipeline/collect_historical.py --incremental --hours=3
            else
              echo "‚ùå collect_historical.py not found!"
              echo "üìÅ Available in data_pipeline:"
              ls -la data_pipeline/ 2>/dev/null || echo "data_pipeline/ not found"
            fi
            ;;
            
          "data_full")
            echo "üìö Running full data collection..."
            if [ -f "data_pipeline/collect_historical.py" ]; then
              python data_pipeline/collect_historical.py
            else
              echo "‚ùå collect_historical.py not found!"
            fi
            ;;
            
          "features")
            echo "üîß Running feature engineering..."
            if [ -f "data_pipeline/feature.py" ]; then
              python data_pipeline/feature.py
            else
              echo "‚ùå feature.py not found!"
            fi
            ;;
            
          "train_combined")
            echo "ü§ñ Running COMBINED training (your script)..."
            if [ -f "model_training/combinedtraining.py" ]; then
              python model_training/combinedtraining.py
            else
              echo "‚ùå combinedtraining.py not found!"
              echo "üìÅ Checking model_training directory:"
              ls -la model_training/ 2>/dev/null || echo "model_training/ not found"
            fi
            ;;
            
          "predictions")
            echo "üîÆ Running prediction service..."
            if [ -f "model_training/prediction_service.py" ]; then
              python model_training/prediction_service.py
            else
              echo "‚ùå prediction_service.py not found!"
            fi
            ;;
            
          "full")
            echo "üöÄ Running FULL PIPELINE..."
            
            echo "1Ô∏è‚É£ Collecting data..."
            if [ -f "data_pipeline/collect_historical.py" ]; then
              python data_pipeline/collect_historical.py --incremental --hours=24
            else
              echo "‚ö†Ô∏è Skipping data collection - script not found"
            fi
            
            echo "2Ô∏è‚É£ Engineering features..."
            if [ -f "data_pipeline/feature.py" ]; then
              python data_pipeline/feature.py
            else
              echo "‚ö†Ô∏è Skipping feature engineering - script not found"
            fi
            
            echo "3Ô∏è‚É£ Running combined training..."
            if [ -f "model_training/combinedtraining.py" ]; then
              python model_training/combinedtraining.py
            else
              echo "‚ö†Ô∏è Skipping training - script not found"
            fi
            
            echo "‚úÖ Full pipeline completed!"
            ;;
        esac
        
        echo "‚úÖ Step $STEP completed"
    
    - name: Verify pipeline output
      if: steps.determine_step.outputs.step == 'train_combined' || steps.determine_step.outputs.step == 'full'
      run: |
        echo "üîç Verifying pipeline output..."
        cd aqi-karachi
        python -c "
        from pymongo import MongoClient
        import os
        
        try:
            client = MongoClient(os.getenv('MONGODB_URI'), serverSelectionTimeoutMS=5000)
            
            aqi_db = client['aqi_predictor']
            collections = aqi_db.list_collection_names()
            print('üìä Collections in aqi_predictor:', collections)
            
            key_collections = ['ml_forecasts_3day', 'timeseries_forecasts_3day', 'ensemble_forecasts_3day', 'forecasts']
            for coll in key_collections:
                if coll in collections:
                    count = aqi_db[coll].count_documents({})
                    print(f'‚úÖ {coll}: {count} records')
                else:
                    print(f'‚ö†Ô∏è  {coll}: NOT FOUND')
            
            if 'aqi_model_registry' in client.list_database_names():
                mr_db = client['aqi_model_registry']
                models = mr_db.model_registry.count_documents({})
                print(f'‚úÖ Models in registry: {models}')
            else:
                print('‚ö†Ô∏è  Model registry database not found')
            
            client.close()
            
        except Exception as e:
            print(f'‚ùå Verification error: {e}')
        "
    
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        rm -f aqi-karachi/.env 2>/dev/null || true
    
    - name: Summary
      if: always()
      run: |
        echo "üìä PIPELINE SUMMARY"
        echo "Run ID: ${{ github.run_id }}"
        echo "Run Number: ${{ github.run_number }}"
        echo "Step: ${{ steps.determine_step.outputs.step }}"
        echo "Status: ${{ job.status }}"
        echo "Project Directory: aqi-karachi"
        echo "Time Karachi: $(TZ='Asia/Karachi' date '+%Y-%m-%d %H:%M:%S %Z')"
        echo "üëâ Check MongoDB Atlas for new data"
