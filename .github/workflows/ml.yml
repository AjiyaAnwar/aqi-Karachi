# .github/workflows/main.yml
name: AQI Karachi ML Pipeline - PRODUCTION FIXED

on:
  schedule:
    - cron: '0 */3 * * *'    # Every 3 hours
    - cron: '0 1 * * *'      # Daily at 1 AM UTC
    - cron: '0 4 * * *'      # 4 AM UTC
    - cron: '0 16 * * *'     # 4 PM UTC
    - cron: '0 5 * * 0'      # Sunday at 5 AM UTC
  
  workflow_dispatch:
    inputs:
      pipeline_step:
        description: 'Select pipeline step'
        required: false
        default: 'full'
        type: choice
        options:
          - data_incremental
          - data_full
          - features
          - train_combined
          - predictions
          - full
  
  push:
    branches: [main]
    paths:
      - 'data_pipeline/**'
      - 'model_training/**'
      - '.github/workflows/**'
      - 'requirements.txt'

jobs:
  execute-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment: production
    
    env:
      # MongoDB Configuration (from secrets)
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      
      # Static configuration matching your .env
      MONGODB_DATABASE: aqi_predictor
      FEATURE_STORE_DB: aqi_feature_store
      MODEL_REGISTRY_DB: aqi_model_registry
      LOGS_DB: aqi_pipeline_logs
      
      # City Configuration
      CITY_NAME: Karachi
      CITY_LAT: 24.8607
      CITY_LON: 67.0011
      TIMEZONE: Asia/Karachi
      
      # Pipeline Settings
      HISTORICAL_DAYS: 45
      COLLECTION_INTERVAL_HOURS: 1
      TRAINING_THRESHOLD: 0.7
      MODEL_PROMOTION_THRESHOLD: 0.75
      
      # System
      GITHUB_ACTIONS: true
      LOG_LEVEL: INFO
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt  # Create this file if needed
        pip install pymongo python-dotenv pandas numpy scikit-learn joblib
    
    - name: Create .env file for scripts
      run: |
        echo "Creating .env file for Python scripts..."
        cat << EOF > .env
        # Auto-generated from GitHub Secrets and workflow env
        MONGODB_URI=${{ secrets.MONGODB_URI }}
        MONGODB_DATABASE=aqi_predictor
        FEATURE_STORE_DB=aqi_feature_store
        MODEL_REGISTRY_DB=aqi_model_registry
        LOGS_DB=aqi_pipeline_logs
        CITY_NAME=Karachi
        CITY_LAT=24.8607
        CITY_LON=67.0011
        TIMEZONE=Asia/Karachi
        HISTORICAL_DAYS=45
        COLLECTION_INTERVAL_HOURS=1
        GITHUB_ACTIONS=true
        LOG_LEVEL=INFO
        EOF
        
        echo "üîê .env file created (MongoDB URI masked)"
        head -5 .env
    
    - name: Test MongoDB connection
      run: |
        echo "üîå Testing MongoDB connection..."
        python -c "
        import os
        from pymongo import MongoClient
        from urllib.parse import quote_plus
        
        uri = os.getenv('MONGODB_URI')
        print(f'URI present: {'Yes' if uri else 'No'}")
        print(f'URI length: {len(uri) if uri else 0}')
        
        if not uri:
            print('‚ùå MONGODB_URI not found in environment')
            exit(1)
        
        try:
            # Test connection
            client = MongoClient(uri, serverSelectionTimeoutMS=5000)
            client.server_info()
            print('‚úÖ MongoDB connection successful')
            
            # List databases
            dbs = client.list_database_names()
            print(f'üìä Available databases: {len(dbs)}')
            
            # Check if our database exists
            target_db = 'aqi_predictor'
            if target_db in dbs:
                print(f'‚úÖ Target database ({target_db}) exists')
                collections = client[target_db].list_collection_names()
                print(f'   Collections: {collections}')
            else:
                print(f'‚ö†Ô∏è  Target database ({target_db}) not found')
                
        except Exception as e:
            print(f'‚ùå MongoDB connection failed: {e}')
            exit(1)
        "
    
    # Rest of your steps remain the same...
    - name: Determine pipeline step
      id: determine_step
      run: |
        echo "üîç Determining pipeline step..."
        # ... your existing code ...
